---
// result.astro å®Œå…¨ç‰ˆ
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { rdb } from "../../../firebase/client";
import { ref, get } from "firebase/database";

// URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
const { opponent } = Astro.params;
const url = Astro.request.url;
const searchParams = new URL(url).searchParams;
const myId = searchParams.get("user") || "testUser1";
const opponentId = myId === "testUser1" ? "testUser2" : "testUser1";
const safeOpponent = (opponent ?? "unknown").replace(/\./g, "_");

// DBã‹ã‚‰å–å¾—ï¼ˆã“ã‚ŒãŒè¶…é‡è¦ï¼ï¼‰
let myTodos = [];
let oppTodos = [];
try {
    const mySnap = await get(ref(rdb, `duels/${safeOpponent}/${myId}`));
    const oppSnap = await get(ref(rdb, `duels/${safeOpponent}/${opponentId}`));
    myTodos = mySnap.exists() ? mySnap.val() : [];
    oppTodos = oppSnap.exists() ? oppSnap.val() : [];
} catch {
    myTodos = [];
    oppTodos = [];
}

// ã‚¿ã‚¹ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
type Todo = { label: string; checked?: boolean };

const exerciseLabels = [
    "è…¹ç­‹ï¼š20å›ž",
    "è…•ç«‹ã¦ï¼š20å›ž",
    "èƒŒç­‹ï¼š20å›ž",
    "ãƒ—ãƒ©ãƒ³ã‚¯ï¼š50ç§’",
    "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ï¼š20åˆ†",
    "ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°ï¼š20åˆ†",
    "ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆï¼š30å›ž",
];
const cleaningLabels = [
    "ã‚´ãƒŸã‚’ã¾ã¨ã‚ã‚‹",
    "æ´‹æœã‚’ç•³ã‚€",
    "çŽ„é–¢ã®æŽƒé™¤",
    "ãƒˆã‚¤ãƒ¬æŽƒé™¤",
    "ã‚­ãƒƒãƒãƒ³ã®ã‚·ãƒ³ã‚¯æŽƒé™¤",
    "æ´—é¢å°ã®é¡ã‚’æ‹­ã",
    "ã‚¹ãƒžãƒ›ã®å†™çœŸæ•´ç†",
];
const cookLabels = [
    "1å“ã ã‘æ–™ç†ã™ã‚‹",
    "æœé£Ÿã‚»ãƒƒãƒˆã‚’ã¤ãã‚‹",
    "ä»Šæ—¥é£Ÿã¹ãŸã„ã‚‚ã®ã‚’1å“ä½œã‚‹",
    "ä½œã£ãŸæ–™ç†ã®å†™çœŸã‚’æ’®ã£ã¦ä¿å­˜",
    "ãƒ©ãƒ¼ãƒ¡ãƒ³ï¼‹é‡Žèœãƒˆãƒƒãƒ”ãƒ³ã‚°",
    "ä½œã£ãŸæ–™ç†ã®å·¥ç¨‹ã‚’ãƒ¡ãƒ¢",
    "æ¬¡ã«ä½œã‚ŠãŸã„æ–™ç†ã‚’ãƒ¡ãƒ¢",
];
const readLabels = [
    "å›³æ›¸é¤¨ã®æœ¬ã‚’ä¸€å†Šå€Ÿã‚Šã‚‹",
    "æ°—ã«ãªã‚‹ç›®æ¬¡ã®ç« ã‚’ãƒ¡ãƒ¢ã‚‹",
    "1ç« èª­ã¿åˆ‡ã‚‹",
    "å°èª¬ã‚’5ãƒšãƒ¼ã‚¸èª­ã‚€",
    "å¿ƒã«æ®‹ã£ãŸä¸€æ–‡ã‚’ãƒ¡ãƒ¢å¸³ã«æ›¸ã",
    "èª­ã‚“ã å†…å®¹ã‚’ä¸€è¨€ã§ãƒ¡ãƒ¢ã™ã‚‹",
    "æ„Ÿæƒ³ã‚’3è¡Œã§æ›¸ã„ã¦ã¿ã‚‹",
];
const stretchLabels = [
    "é¢¨å‘‚ä¸ŠãŒã‚Šã‚¹ãƒˆãƒ¬ãƒƒãƒï¼š5åˆ†",
    "å¯ã‚‹å‰ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼š3åˆ†",
    "é¦–ã‚’ã‚†ã£ãã‚Šå·¦å³ã«å€’ã™ï¼ˆå„10ç§’Ã—3ï¼‰",
    "è¶³é¦–ã‚’ã‚†ã£ãã‚Šå›žã™ï¼ˆå·¦å³Ã—30ç§’ï¼‰",
    "æ°—æŒã¡ã‚ˆã‹ã£ãŸã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’ãƒ¡ãƒ¢",
    "å¤ªã‚‚ã‚‚è£ã‚’ä¼¸ã°ã™å‰å±ˆã‚¹ãƒˆãƒ¬ãƒƒãƒ",
    "ä»Šæ—¥ä¼¸ã°ã—ãŸéƒ¨ä½ã‚’ãƒ¡ãƒ¢",
];

function calcBattle(myTodos: Todo[], oppTodos: Todo[]) {
    let myHP = 80;
    let oppHP = 60;

    myTodos.forEach((todo: Todo) => {
        if (!todo.checked) return;
        const label = todo.label;
        if (exerciseLabels.includes(label) || cleaningLabels.includes(label))
            oppHP -= 10;
        if (
            cookLabels.includes(label) ||
            readLabels.includes(label) ||
            stretchLabels.includes(label)
        )
            myHP += 10;
    });
    oppTodos.forEach((todo: Todo) => {
        if (!todo.checked) return;
        const label = todo.label;
        if (exerciseLabels.includes(label) || cleaningLabels.includes(label))
            myHP -= 10;
        if (
            cookLabels.includes(label) ||
            readLabels.includes(label) ||
            stretchLabels.includes(label)
        )
            oppHP += 10;
    });

    myHP = Math.max(0, myHP);
    oppHP = Math.max(0, oppHP);

    let winner: "draw" | "me" | "opp" = "draw";
    if (myHP > oppHP) winner = "me";
    if (myHP < oppHP) winner = "opp";
    return { myHP, oppHP, winner };
}
const { myHP, oppHP, winner } = calcBattle(myTodos, oppTodos);
---

<style lang="scss">
    .result-wrap {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin: 2rem 0;
        .player {
            flex: 1;
            color: #fff;
            text-align: center;
            h1 {
                font-size: 2.3rem;
                margin-bottom: 1rem;
            }
            .bar {
                width: 110px;
                height: 22px;
                border-radius: 12px;
                margin: 0.7rem auto;
                background: #19df5b;
                &.gray {
                    background: #bbb;
                    border: 3px dotted #fff;
                }
            }
            .winner {
                margin-top: 1.3rem;
                color: #ffbc2e;
                font-size: 2rem;
                font-weight: bold;
                text-align: left;
                .crown {
                    font-size: 2.3rem;
                    vertical-align: middle;
                }
                span {
                    font-size: 2.1rem;
                    border-bottom: 4px solid #ffbc2e;
                }
            }
        }
    }
    .end-btn {
        display: block;
        margin: 2rem auto 0;
        background: #ba2b1d;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 1.5rem;
        padding: 0.7rem 2.5rem;
        font-weight: bold;
    }
</style>

<BaseLayout>
    <div class="result-wrap">
        <div class="player player-self">
            <h1>è‡ªåˆ†</h1>
            <div>æ®‹ã‚ŠHP{myHP}</div>
            <div class={`bar ${myHP > 0 ? "" : "gray"}`}></div>
            {
                winner === "me" && (
                    <div class="winner">
                        <span class="crown">ðŸ‘‘</span>
                        <span>Winner</span>
                    </div>
                )
            }
        </div>
        <div class="player player-opponent">
            <h1>ç›¸æ‰‹</h1>
            <div>æ®‹ã‚ŠHP{oppHP}</div>
            <div class={`bar ${oppHP > 0 ? "" : "gray"}`}></div>
            {
                winner === "opp" && (
                    <div class="winner">
                        <span class="crown">ðŸ‘‘</span>
                        <span>Winner</span>
                    </div>
                )
            }
        </div>
    </div>
    <button id="endBtn" class="end-btn">ãƒ‡ãƒ¥ã‚¨ãƒ«çµ‚äº†</button>
</BaseLayout>

<script>
    document.getElementById("endBtn")?.addEventListener("click", () => {
        window.location.href = "/";
    });
</script>
